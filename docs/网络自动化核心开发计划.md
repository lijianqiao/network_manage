# 🚀 网络自动化核心开发计划

> 基于设计方案的分阶段开发计划，确保功能模块有序实现和集成测试

---

## 📋 开发顺序总览

```
阶段1: 核心基础模块（配置模板系统）
    ↓
阶段2: 凭据管理与安全模块
    ↓
阶段3: 设备连接与基础自动化
    ↓
阶段4: 配置管理与回滚系统
    ↓
阶段5: 实时监控与CLI交互
    ↓
阶段6: 高级功能与性能优化
```

---

## 🎯 第一阶段：配置模板系统（优先级：🔥🔥🔥）

### ✅ 为什么先做配置模板？
- **核心依赖**：所有自动化操作都依赖配置模板
- **数据基础**：为后续功能提供模板数据支撑
- **功能验证**：可以独立测试模板渲染和管理功能

### 📝 具体开发任务

#### 1.1 配置模板 API 端点（1-2天）
```bash
# 创建文件路径
app/api/v1/endpoints/config_templates.py
```

**API 功能列表**：
- `POST /config-templates/` - 创建配置模板
- `GET /config-templates/` - 分页查询模板
- `GET /config-templates/{id}` - 获取模板详情
- `PUT /config-templates/{id}` - 更新模板
- `DELETE /config-templates/{id}` - 删除模板
- `GET /config-templates/stats/count` - 统计模板数量
- `GET /config-templates/export` - 导出模板数据
- `POST /config-templates/import` - 导入模板数据
- `GET /config-templates/fields` - 获取字段信息

#### 1.2 模板命令 API 端点（1-2天）
```bash
# 创建文件路径
app/api/v1/endpoints/template_commands.py
```

**API 功能列表**：
- `POST /template-commands/` - 创建模板命令
- `GET /template-commands/` - 分页查询命令
- `GET /template-commands/{id}` - 获取命令详情
- `PUT /template-commands/{id}` - 更新命令
- `DELETE /template-commands/{id}` - 删除命令
- `GET /template-commands/template/{template_id}` - 根据模板获取命令
- `GET /template-commands/brand/{brand_id}` - 根据品牌获取命令

#### 1.3 模板渲染功能（1天）
```bash
# 核心功能模块
app/services/template_service.py
app/utils/jinja_renderer.py
```

**核心功能**：
- Jinja2 模板渲染引擎
- 模板语法验证
- 变量注入和验证
- 渲染结果预览

#### 1.4 基础模板数据（半天）
创建基础模板数据：
- MAC地址查询模板（华三、华为、思科）
- 端口配置模板
- VLAN查询模板
- 设备状态查询模板

---

## 🎯 第二阶段：凭据管理与安全模块（优先级：🔥🔥）

### 📝 具体开发任务

#### 2.1 密码加密管理（1天）
```bash
app/utils/password_encryption.py
app/core/credential_manager.py
```

**核心功能**：
- Fernet对称加密实现
- 密码加密/解密函数
- 密钥管理和轮换
- 安全缓存机制

#### 2.2 凭据管理器（2天）
```bash
app/services/credential_service.py
```

**核心功能**：
- 动态凭据解析逻辑
- OTP密码支持
- Enable密码处理
- 凭据优先级决策

#### 2.3 设备连接状态管理（1天）
```bash
app/api/v1/endpoints/device_connection_status.py
app/services/connection_status_service.py
```

**API 功能列表**：
- `GET /device-connection-status/` - 获取连接状态列表
- `GET /device-connection-status/{device_id}` - 获取设备连接状态
- `POST /device-connection-status/check` - 检查设备连通性
- `GET /device-connection-status/stats` - 连接状态统计

---

## 🎯 第三阶段：设备连接与基础自动化（优先级：🔥🔥）

### 📝 具体开发任务

#### 3.1 Scrapli连接管理（2-3天）
```bash
app/network_automation/connection_manager.py
app/network_automation/scrapli_driver.py
```

**核心功能**：
- 基础设备连接
- 连接池管理
- 超时控制
- 品牌驱动适配（华三、华为、思科）

#### 3.2 基础并发控制（1天）
```bash
app/network_automation/concurrency_controller.py
```

**核心功能**：
- 信号量并发控制
- 连接限制管理
- 超时处理

#### 3.3 设备自动化API（2天）
```bash
app/api/v1/endpoints/device_automation.py
```

**API 功能列表**：
- `POST /devices/{id}/connect` - 连接设备（支持动态密码）
- `POST /devices/{id}/execute-template/{template_id}` - 执行配置模板
- `POST /devices/{id}/execute-command` - 执行单条命令
- `GET /devices/{id}/connection-status` - 获取连接状态

---

## 🎯 第四阶段：配置管理与回滚系统（优先级：🔥）

### 📝 具体开发任务

#### 4.1 配置快照管理（2天）
```bash
app/api/v1/endpoints/config_snapshots.py
app/services/config_snapshot_service.py
```

**API 功能列表**：
- `POST /config-snapshots/` - 创建配置快照
- `GET /config-snapshots/` - 分页查询快照
- `GET /config-snapshots/{id}` - 获取快照详情
- `POST /config-snapshots/compare` - 比较配置差异

#### 4.2 配置差异分析（1天）
```bash
app/api/v1/endpoints/config_diffs.py
app/services/config_diff_service.py
app/utils/diff_analyzer.py
```

**核心功能**：
- 配置差异对比算法
- 统一差异格式生成
- 可视化差异报告

#### 4.3 回滚操作管理（2天）
```bash
app/api/v1/endpoints/rollback_operations.py
app/services/rollback_service.py
```

**API 功能列表**：
- `POST /rollback-operations/` - 创建回滚操作
- `GET /rollback-operations/` - 查询回滚历史
- `POST /rollback-operations/{id}/execute` - 执行回滚
- `GET /rollback-operations/{id}/status` - 查询回滚状态

---

## 🎯 第五阶段：实时监控与CLI交互（优先级：⚡）

### 📝 具体开发任务

#### 5.1 SNMP监控模块（2天）
```bash
app/services/snmp_monitor_service.py
app/utils/snmp_client.py
```

**核心功能**：
- SNMP状态查询
- 设备可达性检测
- 性能指标收集
- 连接失败记录

#### 5.2 实时CLI WebSocket（3天）
```bash
app/api/v1/websockets/device_cli.py
app/services/websocket_session_service.py
```

**核心功能**：
- WebSocket连接管理
- CLI会话管理
- 实时命令交互
- 会话超时控制

#### 5.3 设备监控API（1天）
```bash
app/api/v1/endpoints/device_monitoring.py
```

**API 功能列表**：
- `GET /devices/{id}/snmp-status` - 获取SNMP状态
- `GET /devices/{id}/performance` - 获取性能指标
- `POST /devices/batch-check` - 批量检查设备状态

---

## 🎯 第六阶段：高级功能与性能优化（优先级：⭐）

### 📝 具体开发任务

#### 6.1 Nornir集成（2-3天）
```bash
app/network_automation/nornir_manager.py
app/network_automation/task_executor.py
```

**核心功能**：
- 动态Inventory生成
- 批量任务执行
- 结果聚合处理
- 任务调度管理

#### 6.2 TTP输出解析（1天）
```bash
app/utils/ttp_parser.py
app/services/output_parser_service.py
```

**核心功能**：
- TTP模板管理
- 结构化输出解析
- 多格式输出支持

#### 6.3 性能优化（1-2天）
- 连接池优化
- 缓存机制完善
- 并发性能调优
- 内存使用优化

---

## 📅 开发时间规划

| 阶段     | 预计时间    | 主要交付物                     |
| -------- | ----------- | ------------------------------ |
| 阶段1    | 4-5天       | 配置模板完整API + 基础模板数据 |
| 阶段2    | 4天         | 凭据管理 + 设备连接状态API     |
| 阶段3    | 5-6天       | 设备连接 + 基础自动化功能      |
| 阶段4    | 5天         | 配置管理 + 回滚系统            |
| 阶段5    | 6天         | SNMP监控 + WebSocket CLI       |
| 阶段6    | 4-6天       | Nornir集成 + 性能优化          |
| **总计** | **28-32天** | **完整网络自动化系统**         |

---

## 🔧 开发注意事项

### 💡 开发原则
1. **先核心后扩展**：优先实现核心功能，再添加高级特性
2. **先单设备后批量**：确保单设备操作稳定后再支持批量
3. **先同步后异步**：基础功能用同步实现，性能优化时转异步
4. **先功能后性能**：确保功能正确性后再进行性能优化

### 🧪 测试策略
- **每个阶段完成后进行集成测试**
- **使用模拟设备进行功能验证**
- **真实设备测试前先用测试环境**
- **重点测试错误处理和异常情况**

### 📦 依赖安装
```bash
# 核心网络自动化依赖
pip install scrapli scrapli-community
pip install nornir nornir-scrapli
pip install jinja2 ttp
pip install cryptography  # Fernet加密
pip install pysnmp easysnmp  # SNMP支持
```

---

## ✅ 总结

**第一步开始**：配置模板系统（阶段1）
- 创建 `config_templates.py` 和 `template_commands.py` API端点
- 实现基础的CRUD操作
- 添加Jinja2模板渲染功能

这个开发顺序确保了：
1. **依赖关系合理**：后续功能依赖前面的基础模块
2. **风险控制**：核心功能优先，降低项目风险
3. **测试友好**：每个阶段都可以独立测试验证
4. **渐进式开发**：功能逐步完善，便于调试和优化
