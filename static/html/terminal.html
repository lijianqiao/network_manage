<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè®¾å¤‡ç»ˆç«¯ - WebSSH CLI</title>

    <!-- Xterm.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: #2d2d30;
            padding: 8px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 40px;
        }

        .header h1 {
            font-size: 14px;
            color: #cccccc;
        }

        .connection-panel {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-panel input {
            background: #3c3c3c;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .connection-panel input:focus {
            outline: none;
            border-color: #007acc;
        }

        .connection-panel button {
            background: #0e639c;
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .connection-panel button:hover {
            background: #1177bb;
        }

        .connection-panel button:disabled {
            background: #666666;
            cursor: not-allowed;
        }

        .status-bar {
            background: #007acc;
            color: white;
            padding: 4px 15px;
            font-size: 12px;
            height: 24px;
            display: flex;
            align-items: center;
        }

        .status-bar.connected {
            background: #16825d;
        }

        .status-bar.disconnected {
            background: #a1260d;
        }

        .status-bar.connecting {
            background: #ca5010;
        }

        .status-bar.error {
            background: #a80000;
        }

        .terminal-container {
            height: calc(100vh - 64px);
            background: #000000;
            position: relative;
        }

        #terminal {
            height: 100%;
            width: 100%;
        }

        /* è¿æ¥å¯¹è¯æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2d2d30;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #3e3e42;
            min-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            color: #cccccc;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            color: #cccccc;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: #3c3c3c;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 8px;
            border-radius: 3px;
            font-size: 13px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007acc;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }

        .modal-buttons button {
            background: #0e639c;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 13px;
        }

        .modal-buttons button:hover {
            background: #1177bb;
        }

        .modal-buttons button.cancel {
            background: #666666;
        }

        .modal-buttons button.cancel:hover {
            background: #777777;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸŒ ç½‘ç»œè®¾å¤‡ç»ˆç«¯</h1>
        <div class="connection-panel">
            <input type="text" id="quickHost" placeholder="ä¸»æœºIPåœ°å€" style="width: 150px;">
            <input type="text" id="quickUsername" placeholder="ç”¨æˆ·å" style="width: 100px;">
            <input type="password" id="quickPassword" placeholder="å¯†ç " style="width: 100px;">
            <button id="connectBtn" onclick="showConnectionDialog()">è¿æ¥</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>æ–­å¼€</button>
            <button onclick="clearTerminal()">æ¸…å±</button>
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar disconnected" id="statusBar">
        æœªè¿æ¥ - è¯·è¾“å…¥ä¸»æœºä¿¡æ¯åç‚¹å‡»è¿æ¥
    </div>

    <!-- ç»ˆç«¯åŒºåŸŸ -->
    <div class="terminal-container">
        <div id="terminal"></div>
    </div>

    <!-- è¿æ¥é…ç½®å¯¹è¯æ¡† -->
    <div class="modal" id="connectionModal">
        <div class="modal-content">
            <div class="modal-title">è¿æ¥åˆ°ç½‘ç»œè®¾å¤‡</div>
            <div class="form-group">
                <label>ä¸»æœºåœ°å€ *</label>
                <input type="text" id="modalHost" placeholder="ä¾‹å¦‚: 192.168.1.1">
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="modalUsername" placeholder="é»˜è®¤: admin">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="modalPassword" placeholder="è®¾å¤‡ç™»å½•å¯†ç ">
            </div>
            <div class="form-group">
                <label>Enableå¯†ç </label>
                <input type="password" id="modalEnablePassword" placeholder="ç‰¹æƒæ¨¡å¼å¯†ç ï¼ˆå¯é€‰ï¼‰">
            </div>
            <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="modalPort" placeholder="22" value="22">
            </div>
            <div class="form-group">
                <label>è®¾å¤‡å¹³å°</label>
                <select id="modalPlatform">
                    <option value="cisco_ios">Cisco IOS</option>
                    <option value="cisco_nxos">Cisco NX-OS</option>
                    <option value="cisco_iosxr">Cisco IOS-XR</option>
                    <option value="huawei_vrp">åä¸º VRP</option>
                    <option value="h3c_comware">H3C Comware</option>
                    <option value="generic">é€šç”¨</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="cancel" onclick="hideConnectionDialog()">å–æ¶ˆ</button>
                <button onclick="connectToDevice()">è¿æ¥</button>
            </div>
        </div>
    </div>

    <!-- Xterm.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let term = null;
        let fitAddon = null;
        let ws = null;
        let sessionId = null;
        let isConnected = false;
        let currentHost = '';
        let commandHistory = [];
        let historyIndex = -1;
        let currentCommand = '';

        // DOMå…ƒç´ 
        const statusBar = document.getElementById('statusBar');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionModal = document.getElementById('connectionModal');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initializeTerminal();

            // ç»‘å®šå¿«é€Ÿè¿æ¥å›è½¦é”®
            document.getElementById('quickHost').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    quickConnect();
                }
            });

            // ç»‘å®šæ¨¡æ€æ¡†å›è½¦é”®
            document.getElementById('modalHost').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    connectToDevice();
                }
            });
        });

        // åˆå§‹åŒ–ç»ˆç«¯
        function initializeTerminal() {
            // åˆ›å»ºç»ˆç«¯å®ä¾‹
            term = new Terminal({
                cols: 80,
                rows: 24,
                cursorBlink: true,
                theme: {
                    background: '#000000',
                    foreground: '#ffffff',
                    cursor: '#ffffff',
                    selection: '#3369ff',
                    black: '#000000',
                    red: '#ff0000',
                    green: '#00ff00',
                    yellow: '#ffff00',
                    blue: '#0000ff',
                    magenta: '#ff00ff',
                    cyan: '#00ffff',
                    white: '#ffffff',
                    brightBlack: '#808080',
                    brightRed: '#ff8080',
                    brightGreen: '#80ff80',
                    brightYellow: '#ffff80',
                    brightBlue: '#8080ff',
                    brightMagenta: '#ff80ff',
                    brightCyan: '#80ffff',
                    brightWhite: '#ffffff'
                },
                fontSize: 14,
                fontFamily: 'Consolas, Monaco, "Courier New", monospace',
                allowTransparency: false,
                convertEol: true
            });

            // æ·»åŠ è‡ªé€‚åº”æ’ä»¶
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            // æ‰“å¼€ç»ˆç«¯
            term.open(document.getElementById('terminal'));
            fitAddon.fit();

            // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                fitAddon.fit();
            });

            // å¤„ç†ç”¨æˆ·è¾“å…¥
            term.onData(handleTerminalInput);

            // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
            term.writeln('\x1b[32mæ¬¢è¿ä½¿ç”¨ç½‘ç»œè®¾å¤‡ç»ˆç«¯ï¼\x1b[0m');
            term.writeln('\x1b[36mè¯·ç‚¹å‡»"è¿æ¥"æŒ‰é’®è¿æ¥åˆ°ç½‘ç»œè®¾å¤‡ã€‚\x1b[0m');
            term.writeln('');
        }

        // å¤„ç†ç»ˆç«¯è¾“å…¥
        function handleTerminalInput(data) {
            if (!isConnected) {
                return;
            }

            // å¤„ç†ç‰¹æ®Šå­—ç¬¦
            if (data === '\r') { // å›è½¦é”®
                if (currentCommand.trim()) {
                    executeCommand(currentCommand.trim());
                    commandHistory.unshift(currentCommand.trim());
                    if (commandHistory.length > 100) {
                        commandHistory.pop();
                    }
                }
                currentCommand = '';
                historyIndex = -1;
            } else if (data === '\x7f') { // é€€æ ¼é”®
                if (currentCommand.length > 0) {
                    currentCommand = currentCommand.slice(0, -1);
                    term.write('\b \b');
                }
            } else if (data === '\x1b[A') { // ä¸Šç®­å¤´
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    replaceCurrentCommand(commandHistory[historyIndex]);
                }
            } else if (data === '\x1b[B') { // ä¸‹ç®­å¤´
                if (historyIndex > 0) {
                    historyIndex--;
                    replaceCurrentCommand(commandHistory[historyIndex]);
                } else if (historyIndex === 0) {
                    historyIndex = -1;
                    replaceCurrentCommand('');
                }
            } else if (data === '\t') { // Tabé”® - å¯ä»¥æ·»åŠ è‡ªåŠ¨è¡¥å…¨
                // è¿™é‡Œå¯ä»¥æ·»åŠ å‘½ä»¤è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½
            } else if (data >= ' ' && data <= '~') { // å¯æ‰“å°å­—ç¬¦
                currentCommand += data;
                term.write(data);
            }
        }

        // æ›¿æ¢å½“å‰å‘½ä»¤
        function replaceCurrentCommand(newCommand) {
            // æ¸…é™¤å½“å‰è¡Œ
            const clearLength = currentCommand.length;
            term.write('\b'.repeat(clearLength));
            term.write(' '.repeat(clearLength));
            term.write('\b'.repeat(clearLength));

            // å†™å…¥æ–°å‘½ä»¤
            currentCommand = newCommand;
            term.write(newCommand);
        }

        // æ˜¾ç¤ºè¿æ¥å¯¹è¯æ¡†
        function showConnectionDialog() {
            const quickHost = document.getElementById('quickHost').value;
            const quickUsername = document.getElementById('quickUsername').value;
            const quickPassword = document.getElementById('quickPassword').value;

            // å¡«å……å¿«é€Ÿè¾“å…¥çš„å€¼
            if (quickHost) document.getElementById('modalHost').value = quickHost;
            if (quickUsername) document.getElementById('modalUsername').value = quickUsername;
            if (quickPassword) document.getElementById('modalPassword').value = quickPassword;

            connectionModal.classList.add('show');
            document.getElementById('modalHost').focus();
        }

        // éšè—è¿æ¥å¯¹è¯æ¡†
        function hideConnectionDialog() {
            connectionModal.classList.remove('show');
        }

        // å¿«é€Ÿè¿æ¥
        function quickConnect() {
            const host = document.getElementById('quickHost').value.trim();
            const username = document.getElementById('quickUsername').value.trim();
            const password = document.getElementById('quickPassword').value;

            if (!host) {
                updateStatus('è¯·è¾“å…¥ä¸»æœºåœ°å€', 'error');
                return;
            }

            connectToDevice(host, username, password);
        }

        // è¿æ¥åˆ°è®¾å¤‡
        function connectToDevice(host, username, password, enablePassword, port, platform) {
            // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œä»å¯¹è¯æ¡†è·å–
            if (!host) {
                host = document.getElementById('modalHost').value.trim();
                username = document.getElementById('modalUsername').value.trim();
                password = document.getElementById('modalPassword').value;
                enablePassword = document.getElementById('modalEnablePassword').value;
                port = document.getElementById('modalPort').value || 22;
                platform = document.getElementById('modalPlatform').value;
            }

            if (!host) {
                alert('è¯·è¾“å…¥ä¸»æœºåœ°å€ï¼');
                return;
            }

            // éšè—å¯¹è¯æ¡†
            hideConnectionDialog();

            currentHost = host;
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);

            updateStatus('æ­£åœ¨è¿æ¥...', 'connecting');
            term.writeln('\x1b[33mæ­£åœ¨è¿æ¥åˆ° ' + host + '...\x1b[0m');

            const wsUrl = `ws://localhost:8010/api/ws/cli/${host}?session_id=${sessionId}`;

            try {
                ws = new WebSocket(wsUrl);

                ws.onopen = function () {
                    term.writeln('\x1b[32mWebSocketè¿æ¥å·²å»ºç«‹\x1b[0m');

                    // å‘é€è¿æ¥å‘½ä»¤
                    const connectMessage = {
                        type: 'connect',
                        data: {
                            username: username || undefined,
                            password: password || undefined,
                            enable_password: enablePassword || undefined,
                            port: parseInt(port) || 22,
                            platform: platform || 'cisco_ios'
                        }
                    };

                    ws.send(JSON.stringify(connectMessage));
                };

                ws.onmessage = function (event) {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };

                ws.onclose = function () {
                    isConnected = false;
                    updateStatus('è¿æ¥å·²æ–­å¼€', 'disconnected');
                    term.writeln('\x1b[31mè¿æ¥å·²æ–­å¼€\x1b[0m');
                    updateConnectionButtons();
                };

                ws.onerror = function (error) {
                    updateStatus('è¿æ¥é”™è¯¯', 'error');
                    term.writeln('\x1b[31mWebSocketè¿æ¥é”™è¯¯: ' + error + '\x1b[0m');
                };

            } catch (error) {
                updateStatus('è¿æ¥å¤±è´¥', 'error');
                term.writeln('\x1b[31mè¿æ¥å¤±è´¥: ' + error + '\x1b[0m');
            }
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(message) {
            switch (message.type) {
                case 'welcome':
                    term.writeln('\x1b[36m' + message.data.message + '\x1b[0m');
                    break;

                case 'connect':
                    isConnected = true;
                    updateStatus(`å·²è¿æ¥åˆ° ${currentHost}`, 'connected');
                    term.writeln('\x1b[32mè®¾å¤‡è¿æ¥æˆåŠŸï¼\x1b[0m');
                    term.writeln('\x1b[36må¯ä»¥å¼€å§‹è¾“å…¥å‘½ä»¤...\x1b[0m');
                    term.write('\x1b[32m' + currentHost + '# \x1b[0m');
                    updateConnectionButtons();
                    break;

                case 'response':
                    term.writeln('\r');
                    term.write(message.output);
                    if (!message.output.endsWith('\n') && !message.output.endsWith('\r\n')) {
                        term.writeln('');  // æ·»åŠ æ¢è¡Œ
                    }
                    term.write('\x1b[32m' + currentHost + '# \x1b[0m');
                    break;

                case 'error':
                    const errorMsg = message.error + (message.data?.detail ? ': ' + message.data.detail : '');
                    term.writeln('\x1b[31m' + errorMsg + '\x1b[0m');
                    if (isConnected) {
                        term.write('\x1b[32m' + currentHost + '# \x1b[0m');
                    }
                    break;

                case 'disconnect':
                    isConnected = false;
                    updateStatus('å·²æ–­å¼€è¿æ¥', 'disconnected');
                    term.writeln('\x1b[31mè¿æ¥å·²æ–­å¼€: ' + message.reason + '\x1b[0m');
                    updateConnectionButtons();
                    break;
            }
        }

        // æ‰§è¡Œå‘½ä»¤
        function executeCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const commandMessage = {
                    type: 'command',
                    command: command,
                    timeout: 30
                };

                ws.send(JSON.stringify(commandMessage));
            }
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatus(message, status) {
            statusBar.textContent = message;
            statusBar.className = `status-bar ${status}`;
        }

        // æ›´æ–°è¿æ¥æŒ‰é’®çŠ¶æ€
        function updateConnectionButtons() {
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const disconnectMessage = {
                    type: 'disconnect',
                    reason: 'ç”¨æˆ·ä¸»åŠ¨æ–­å¼€'
                };
                ws.send(JSON.stringify(disconnectMessage));
                ws.close();
            }

            isConnected = false;
            updateStatus('å·²æ–­å¼€è¿æ¥', 'disconnected');
            updateConnectionButtons();
        }

        // æ¸…ç©ºç»ˆç«¯
        function clearTerminal() {
            term.clear();
            term.writeln('\x1b[32mç»ˆç«¯å·²æ¸…ç©º\x1b[0m');
            if (isConnected) {
                term.write('\x1b[32m' + currentHost + '# \x1b[0m');
            }
        }

        // å¤„ç†çª—å£å…³é—­
        window.addEventListener('beforeunload', function () {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>

</html>